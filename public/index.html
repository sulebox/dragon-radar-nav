<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Dragon Radar Navigation</title>
    
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <!-- Mapbox Directions Plugin -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">

    <!-- Retro Font -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        :root {
            --radar-bg: #001100;
            --radar-grid: rgba(0, 255, 0, 0.3);
            --radar-bright: #00ff00;
            --dragon-ball: #ffdd00;
            --dragon-ball-glow: #ffaa00;
            --ui-bg: rgba(0, 15, 0, 0.95);
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--radar-bg);
            color: var(--radar-bright);
            font-family: 'VT323', monospace;
            overflow: hidden; /* Prevent body scroll */
        }

        /* --- MAP & OVERLAYS --- */
        #map {
            width: 100%; height: 100%; position: absolute;
            z-index: 1;
            filter: sepia(100%) hue-rotate(50deg) saturate(300%) contrast(1.2) brightness(0.8);
        }

        .radar-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            background-image: 
                linear-gradient(var(--radar-grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--radar-grid) 1px, transparent 1px);
            background-size: 50px 50px;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
        }

        .radar-vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 11;
            background: radial-gradient(circle, transparent 50%, #000 130%);
        }

        .scanline {
            width: 100%; height: 5px; background: rgba(0, 255, 0, 0.4);
            position: absolute; z-index: 12; top: 0; left: 0;
            animation: scan 3s linear infinite; pointer-events: none;
            box-shadow: 0 0 10px var(--radar-bright);
        }
        @keyframes scan {
            0% { top: -10%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 110%; opacity: 0; }
        }

        /* --- UI CUSTOMIZATION (Compact Mode) --- */
        
        /* スマホで見やすいように、入力ボックスと案内板をコンパクト化します。
           Mapbox DirectionsのデフォルトCSSを強力に上書きします。
        */

        /* コンテナ全体の設定 */
        .mapboxgl-ctrl-directions {
            background-color: var(--ui-bg) !important;
            border: 2px solid var(--radar-bright) !important;
            box-shadow: 0 0 15px var(--radar-bright) !important;
            color: var(--radar-bright) !important;
            font-family: 'VT323', monospace;
            min-width: unset !important;
            width: 100% !important; /* 親要素に合わせる */
            max-width: 400px; /* PCでの最大幅 */
            margin: 10px;
        }

        /* 入力ボックス周辺 */
        .directions-inputs {
            padding: 5px 10px !important;
        }

        .mapboxgl-ctrl-directions input {
            background-color: #000 !important;
            color: var(--radar-bright) !important;
            border: 1px solid var(--radar-bright) !important;
            font-family: 'VT323', monospace;
            text-transform: uppercase;
            font-size: 1rem !important;
            height: 30px !important; /* 入力欄を少し小さく */
        }
        
        .mapboxgl-ctrl-directions input::placeholder { color: rgba(0, 255, 0, 0.4); }

        /* モード切替ボタン (Traffic, Driving, Walking...) */
        .directions-control-directions {
            margin: 0 !important;
        }
        
        .mapboxgl-ctrl-directions .directions-profile-switcher {
            background: transparent !important;
            border-bottom: 1px solid var(--radar-bright);
            padding: 5px;
        }
        
        /* 重要な修正: 案内リストのサイズ制限 */
        .directions-control-instructions {
            background-color: var(--ui-bg) !important;
            height: auto !important;
            /* ここがポイント：画面の高さの30%までしか伸ばさない */
            max-height: 30vh !important; 
            overflow-y: auto !important; /* はみ出たらスクロール */
            border-top: 1px solid var(--radar-bright);
        }

        /* スクロールバーもサイバー風に */
        .directions-control-instructions::-webkit-scrollbar {
            width: 8px;
        }
        .directions-control-instructions::-webkit-scrollbar-track {
            background: #001100; 
        }
        .directions-control-instructions::-webkit-scrollbar-thumb {
            background: #00ff00; 
            border-radius: 4px;
        }

        /* モバイル用レイアウト調整 */
        @media screen and (max-width: 640px) {
            /* コントロール配置エリアの設定 */
            .mapboxgl-ctrl-top-left {
                width: 90%; /* 画面幅の90% */
                left: 5% !important; /* 中央寄せ */
                top: 10px !important;
                max-height: 45vh; /* 全体でも画面半分以下に */
                display: flex;
                flex-direction: column;
            }

            .mapboxgl-ctrl-directions {
                width: 100% !important;
                margin: 0 !important;
                font-size: 0.9rem; /* 文字サイズ少し小さく */
            }

            /* 案内テキストの余白調整 */
            .mapbox-directions-step {
                padding: 10px !important;
                border-bottom: 1px solid rgba(0,255,0,0.2);
            }
        }

        /* Header (ロゴ) */
        .radar-header {
            position: absolute; top: 10px; right: 10px; z-index: 0; /* マップの裏に行かないよう注意、でも邪魔ならz-index下げる */
            pointer-events: none; /* クリック邪魔しない */
        }
        .radar-header h1 {
            font-size: 1.2rem; margin: 0; color: rgba(0,255,0,0.7);
            text-shadow: 0 0 5px var(--radar-bright);
        }

        /* --- MARKERS --- */
        .mapboxgl-user-location-dot {
            background-color: transparent !important; width: 30px !important; height: 30px !important; box-shadow: none !important;
        }
        .mapboxgl-user-location-dot::before {
            content: ''; display: block; width: 0; height: 0;
            border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid #ff0000;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            filter: drop-shadow(0 0 5px #ff0000); animation: pulse-red 1s infinite;
        }
        .mapboxgl-user-location-dot::after { display: none !important; }
        @keyframes pulse-red { 0% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); } }

        .dragon-ball-marker {
            width: 24px; height: 24px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--dragon-ball), var(--dragon-ball-glow));
            box-shadow: 0 0 15px var(--dragon-ball), inset -2px -2px 5px rgba(0,0,0,0.5);
            border: 1px solid #fff; position: relative; animation: bounce 2s infinite ease-in-out;
        }
        .dragon-ball-marker::after {
            content: '★'; color: #d94e00; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 12px; line-height: 1;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .loader-text { color: var(--radar-bright); font-size: 2rem; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="loader"><div style="font-size: 4rem;">⌛</div><div class="loader-text">INITIALIZING...</div></div>
    
    <div class="radar-header"><h1>SULE RADAR</h1></div>
    <div class="radar-overlay"></div>
    <div class="radar-vignette"></div>
    <div class="scanline"></div>
    <div id="map"></div>

    <script>
        const loader = document.getElementById('loader');
        
        // Styles
        const customRouteStyles = [
            { 'id': 'directions-route-line-casing', 'type': 'line', 'source': 'directions', 'layout': { 'line-cap': 'round', 'line-join': 'round' }, 'paint': { 'line-color': '#004400', 'line-width': 12 }, 'filter': ['all', ['in', '$type', 'LineString'], ['in', 'route', 'selected']] },
            { 'id': 'directions-route-line', 'type': 'line', 'source': 'directions', 'layout': { 'line-cap': 'round', 'line-join': 'round' }, 'paint': { 'line-color': '#00ff00', 'line-width': 7, 'line-blur': 2 }, 'filter': ['all', ['in', '$type', 'LineString'], ['in', 'route', 'selected']] },
            { 'id': 'directions-origin-point', 'type': 'circle', 'source': 'directions', 'paint': { 'circle-radius': 10, 'circle-color': '#ff0000' }, 'filter': ['all', ['in', '$type', 'Point'], ['in', 'marker-symbol', 'A']] },
            { 'id': 'directions-destination-point', 'type': 'circle', 'source': 'directions', 'paint': { 'circle-radius': 0, 'circle-color': '#000000' }, 'filter': ['all', ['in', '$type', 'Point'], ['in', 'marker-symbol', 'B']] }
        ];

        async function initRadar() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                if (!config.mapboxAccessToken) throw new Error('No Token');
                
                mapboxgl.accessToken = config.mapboxAccessToken;
                const map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/dark-v11',
                    center: [139.7671, 35.6812], zoom: 13, pitch: 0, attributionControl: false
                });

                const directions = new MapboxDirections({
                    accessToken: mapboxgl.accessToken,
                    unit: 'metric',
                    profile: 'mapbox/walking',
                    controls: { instructions: true, profileSwitcher: true },
                    styles: customRouteStyles,
                    interactive: true
                });
                
                // Add to top-left
                map.addControl(directions, 'top-left');

                // Geolocate
                const geolocate = new mapboxgl.GeolocateControl({
                    positionOptions: { enableHighAccuracy: true },
                    trackUserLocation: true,
                    showUserHeading: true
                });
                map.addControl(geolocate, 'bottom-right');

                // Auto set origin logic
                let isOriginSet = false;
                geolocate.on('geolocate', (e) => {
                    if (!isOriginSet) {
                        const coords = [e.coords.longitude, e.coords.latitude];
                        directions.setOrigin(coords);
                        isOriginSet = true;
                    }
                });

                map.on('load', () => {
                    geolocate.trigger();
                    setTimeout(() => { loader.style.display = 'none'; }, 1000);
                });

                directions.on('route', (e) => {
                    if (e.route && e.route.length > 0) customizeDestinationMarker();
                });

            } catch (error) {
                console.error(error);
                document.querySelector('.loader-text').innerText = "ERROR";
                document.querySelector('.loader-text').style.color = "red";
            }
        }

        function customizeDestinationMarker() {
            setTimeout(() => {
                document.querySelectorAll('.mapboxgl-marker').forEach(marker => {
                    if (marker.querySelector('.dragon-ball-marker')) return;
                    if (!marker.classList.contains('mapboxgl-user-location-dot')) {
                        marker.innerHTML = '<div class="dragon-ball-marker"></div>';
                    }
                });
            }, 500);
        }

        initRadar();
    </script>
</body>
</html>
