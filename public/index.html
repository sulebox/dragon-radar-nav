<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Dragon Radar Navigation</title>
    
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <!-- Mapbox Directions Plugin -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">

    <!-- Retro Font -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        :root {
            --radar-bg: #001100;
            --radar-grid: rgba(0, 255, 0, 0.3);
            --radar-bright: #00ff00;
            --dragon-ball: #ffdd00;
            --dragon-ball-glow: #ffaa00;
            --ui-bg: rgba(0, 15, 0, 0.95);
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--radar-bg);
            color: var(--radar-bright);
            font-family: 'VT323', monospace;
            overflow: hidden;
        }

        /* --- MAP & OVERLAYS --- */
        #map {
            width: 100%; height: 100%; position: absolute;
            z-index: 1;
            filter: sepia(100%) hue-rotate(50deg) saturate(300%) contrast(1.2) brightness(0.8);
        }

        .radar-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            background-image: 
                linear-gradient(var(--radar-grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--radar-grid) 1px, transparent 1px);
            background-size: 50px 50px;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
        }

        .radar-vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 11;
            background: radial-gradient(circle, transparent 50%, #000 130%);
        }

        .scanline {
            width: 100%; height: 5px; background: rgba(0, 255, 0, 0.4);
            position: absolute; z-index: 12; top: 0; left: 0;
            animation: scan 3s linear infinite; pointer-events: none;
            box-shadow: 0 0 10px var(--radar-bright);
        }
        @keyframes scan {
            0% { top: -10%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 110%; opacity: 0; }
        }

        /* --- UI CUSTOMIZATION --- */
        .mapboxgl-ctrl-directions {
            background-color: var(--ui-bg) !important;
            border: 2px solid var(--radar-bright) !important;
            box-shadow: 0 0 15px var(--radar-bright) !important;
            color: var(--radar-bright) !important;
            font-family: 'VT323', monospace;
            min-width: unset !important;
            width: 100% !important; max-width: 400px;
            margin: 10px;
        }
        .directions-inputs { padding: 5px 10px !important; }
        .mapboxgl-ctrl-directions input {
            background-color: #000 !important; color: var(--radar-bright) !important;
            border: 1px solid var(--radar-bright) !important;
            font-family: 'VT323', monospace; text-transform: uppercase;
            font-size: 1rem !important; height: 30px !important;
        }
        .mapboxgl-ctrl-directions input::placeholder { color: rgba(0, 255, 0, 0.4); }
        .directions-control-directions { margin: 0 !important; }
        .mapboxgl-ctrl-directions .directions-profile-switcher {
            background: transparent !important; border-bottom: 1px solid var(--radar-bright); padding: 5px;
        }
        .directions-control-instructions {
            background-color: var(--ui-bg) !important; height: auto !important;
            max-height: 30vh !important; overflow-y: auto !important;
            border-top: 1px solid var(--radar-bright);
        }
        .directions-control-instructions::-webkit-scrollbar { width: 8px; }
        .directions-control-instructions::-webkit-scrollbar-track { background: #001100; }
        .directions-control-instructions::-webkit-scrollbar-thumb { background: #00ff00; border-radius: 4px; }

        @media screen and (max-width: 640px) {
            .mapboxgl-ctrl-top-left {
                width: 90%; left: 5% !important; top: 10px !important;
                max-height: 45vh; display: flex; flex-direction: column;
            }
            .mapboxgl-ctrl-directions { width: 100% !important; margin: 0 !important; font-size: 0.9rem; }
            .mapbox-directions-step { padding: 10px !important; border-bottom: 1px solid rgba(0,255,0,0.2); }
        }

        .radar-header {
            position: absolute; top: 10px; right: 10px; z-index: 0; pointer-events: none;
        }
        .radar-header h1 {
            font-size: 1.2rem; margin: 0; color: rgba(0,255,0,0.7);
            text-shadow: 0 0 5px var(--radar-bright);
        }

        /* --- DRAGON BALL MARKERS --- */
        .mapboxgl-user-location-dot {
            background-color: transparent !important; width: 30px !important; height: 30px !important; box-shadow: none !important;
        }
        .mapboxgl-user-location-dot::before {
            content: ''; display: block; width: 0; height: 0;
            border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid #ff0000;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            filter: drop-shadow(0 0 5px #ff0000); animation: pulse-red 1s infinite;
        }
        .mapboxgl-user-location-dot::after { display: none !important; }
        @keyframes pulse-red { 0% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); } }

        .dragon-ball-marker {
            width: 28px; height: 28px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--dragon-ball), var(--dragon-ball-glow));
            box-shadow: 0 0 15px var(--dragon-ball), inset -2px -2px 5px rgba(0,0,0,0.5);
            border: 1px solid #fff; position: relative;
            cursor: pointer; /* Clickable */
            transition: transform 0.2s;
        }
        .dragon-ball-marker:hover { transform: scale(1.2); z-index: 100; }
        
        /* Star rendering via attribute */
        .dragon-ball-marker::after {
            content: attr(data-stars); /* JSでセットした星を表示 */
            color: #d94e00; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px; /* 星が多いと溢れるので小さく */
            line-height: 1; width: 100%; text-align: center;
            letter-spacing: -1px; font-weight: bold;
        }

        /* Popup Styling */
        .mapboxgl-popup { max-width: 200px; z-index: 200; }
        .mapboxgl-popup-content {
            background: var(--ui-bg) !important; color: var(--radar-bright) !important;
            border: 1px solid var(--radar-bright); font-family: 'VT323', monospace;
            padding: 10px; box-shadow: 0 0 10px var(--radar-bright);
        }
        .mapboxgl-popup-close-button { color: var(--radar-bright); }
        .mapboxgl-popup-tip { border-top-color: var(--radar-bright) !important; }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .loader-text { color: var(--radar-bright); font-size: 2rem; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="loader"><div style="font-size: 4rem;">⌛</div><div class="loader-text">SEARCHING...</div></div>
    
    <div class="radar-header"><h1>DRAGON RADAR</h1></div>
    <div class="radar-overlay"></div>
    <div class="radar-vignette"></div>
    <div class="scanline"></div>
    <div id="map"></div>

    <script>
        const loader = document.getElementById('loader');
        
        // Styles for navigation line
        const customRouteStyles = [
            { 'id': 'directions-route-line-casing', 'type': 'line', 'source': 'directions', 'layout': { 'line-cap': 'round', 'line-join': 'round' }, 'paint': { 'line-color': '#004400', 'line-width': 12 }, 'filter': ['all', ['in', '$type', 'LineString'], ['in', 'route', 'selected']] },
            { 'id': 'directions-route-line', 'type': 'line', 'source': 'directions', 'layout': { 'line-cap': 'round', 'line-join': 'round' }, 'paint': { 'line-color': '#00ff00', 'line-width': 7, 'line-blur': 2 }, 'filter': ['all', ['in', '$type', 'LineString'], ['in', 'route', 'selected']] },
            { 'id': 'directions-origin-point', 'type': 'circle', 'source': 'directions', 'paint': { 'circle-radius': 10, 'circle-color': '#ff0000' }, 'filter': ['all', ['in', '$type', 'Point'], ['in', 'marker-symbol', 'A']] },
            { 'id': 'directions-destination-point', 'type': 'circle', 'source': 'directions', 'paint': { 'circle-radius': 0, 'circle-color': '#000000' }, 'filter': ['all', ['in', '$type', 'Point'], ['in', 'marker-symbol', 'B']] }
        ];

        async function initRadar() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                if (!config.mapboxAccessToken) throw new Error('No Token');
                
                mapboxgl.accessToken = config.mapboxAccessToken;
                const map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/dark-v11',
                    center: [139.7671, 35.6812], zoom: 2, /* Start zoomed out to see the world */
                    pitch: 0, attributionControl: false
                });

                const directions = new MapboxDirections({
                    accessToken: mapboxgl.accessToken,
                    unit: 'metric', profile: 'mapbox/walking',
                    controls: { instructions: true, profileSwitcher: true },
                    styles: customRouteStyles, interactive: true
                });
                map.addControl(directions, 'top-left');

                const geolocate = new mapboxgl.GeolocateControl({
                    positionOptions: { enableHighAccuracy: true },
                    trackUserLocation: true, showUserHeading: true
                });
                map.addControl(geolocate, 'bottom-right');

                // Flag to ensure we only scatter balls once
                let ballsScattered = false;

                // When location is found...
                geolocate.on('geolocate', (e) => {
                    if (!ballsScattered) {
                        const userCoords = [e.coords.longitude, e.coords.latitude];
                        
                        // 1. Set navigation origin
                        directions.setOrigin(userCoords);
                        
                        // 2. Scatter Dragon Balls!
                        scatterDragonBalls(map, userCoords);
                        
                        // 3. Zoom into user location
                        map.flyTo({ center: userCoords, zoom: 14, speed: 1.5 });
                        
                        ballsScattered = true;
                    }
                });

                map.on('load', () => {
                    geolocate.trigger(); // Start searching location
                    setTimeout(() => { loader.style.display = 'none'; }, 1000);
                });

                // Style B point marker if set
                directions.on('route', (e) => {
                    if (e.route && e.route.length > 0) customizeDestinationMarker();
                });

            } catch (error) {
                console.error(error);
                document.querySelector('.loader-text').innerText = "ERROR";
            }
        }

        // Logic to scatter 7 balls
        function scatterDragonBalls(map, userCoords) {
            // Star characters
            const stars = ['★', '★★', '★★★', '★★★★', '★★★★★', '★★★★★★', '★★★★★★★'];
            
            // We want the 4-star ball (index 3) to be at user location
            // Others random world-wide
            
            for (let i = 0; i < 7; i++) {
                let coords;
                let isFourStar = (i === 3);

                if (isFourStar) {
                    // Place 4-star ball exactly at user location (slightly offset so it doesn't hide user arrow)
                    coords = [userCoords[0] + 0.0001, userCoords[1] + 0.0001]; 
                } else {
                    // Random coordinates world-wide
                    // Lon: -180 to 180, Lat: -60 to 60 (Avoid polar caps)
                    const lon = (Math.random() * 360) - 180;
                    const lat = (Math.random() * 120) - 60;
                    coords = [lon, lat];
                }

                // Create DOM element for marker
                const el = document.createElement('div');
                el.className = 'dragon-ball-marker';
                el.setAttribute('data-stars', stars[i]); // Set stars CSS content

                // Add click event for address lookup
                el.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent map click
                    showBallLocation(map, coords, stars[i]);
                });

                // Add to map
                new mapboxgl.Marker(el)
                    .setLngLat(coords)
                    .addTo(map);
            }
        }

        // Fetch address and show popup
        async function showBallLocation(map, coords, starName) {
            // Show a temporary loading popup
            const popup = new mapboxgl.Popup({ offset: 25 })
                .setLngLat(coords)
                .setHTML(`<div>Searching Data...</div>`)
                .addTo(map);

            try {
                // Reverse Geocoding API
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?access_token=${mapboxgl.accessToken}&language=ja&types=country,region,place,locality`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                let locationName = "UNCHARTED AREA (洋上/未開の地)";
                if (data.features && data.features.length > 0) {
                    locationName = data.features[0].place_name;
                }

                // Update popup content
                popup.setHTML(`
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem; color:#ffdd00;">${starName}</div>
                        <div style="border-top:1px solid #0f0; margin:5px 0;"></div>
                        <div>${locationName}</div>
                        <div style="font-size:0.8rem; opacity:0.7; margin-top:5px;">
                            LAT: ${coords[1].toFixed(2)}<br>LON: ${coords[0].toFixed(2)}
                        </div>
                    </div>
                `);
                
                // Fly to that ball to see it better
                map.flyTo({ center: coords, zoom: 4 });

            } catch (err) {
                popup.setHTML(`<div>SIGNAL LOST</div>`);
            }
        }

        function customizeDestinationMarker() {
            setTimeout(() => {
                document.querySelectorAll('.mapboxgl-marker').forEach(marker => {
                    // Only customize destination markers (not balls, not user)
                    if (marker.classList.contains('dragon-ball-marker')) return;
                    if (marker.classList.contains('mapboxgl-user-location-dot')) return;
                    
                    // Simple glowing dot for destination Target
                    marker.innerHTML = '<div style="width:20px;height:20px;background:#fff;border-radius:50%;box-shadow:0 0 20px #fff;animation:blink 0.5s infinite;"></div>';
                });
            }, 500);
        }

        initRadar();
    </script>
</body>
</html>
